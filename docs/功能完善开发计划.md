# 飞盘队训练助手 - 功能完善开发计划

**版本**: v1.1.0  
**制定日期**: 2025年7月17日  
**预计完成时间**: 2-3周  

---

## 📋 项目现状分析

### 当前技术架构
- **前端**: 微信原生小程序
- **后端**: 微信云开发 (6个云函数)
- **数据库**: MongoDB 文档数据库 (3个集合)
- **存储**: 微信云存储 (未启用)

### 现有数据结构
```javascript
// Users 集合
{
  _openid: String,
  nickName: String,
  avatarUrl: String,        // 当前只存储微信头像
  role: String,             // 'admin' | 'member'
  isInfoCompleted: Boolean,
  gender: String,
  institute: String,
  realName: String,
  discName: String,         // 飞盘昵称，无修改限制
  contactInfo: String,
  createTime: Date
}

// Events 集合
{
  _id: String,
  creatorId: String,
  title: String,
  eventTime: Date,
  location: String,
  content: String,
  notes: String,
  status: String,           // 'registering' | 'finished'
  createTime: Date,
  updateTime: Date
  // 缺少删除相关字段
}

// Registrations 集合
{
  _id: String,
  eventId: String,
  userId: String,
  status: String,           // 'signed_up' | 'leave_requested' | 'present' | 'absent'
  createTime: Date,
  updateTime: Date
}
```

---

## 🎯 功能需求分析

### 1. 用户头像管理功能
**业务价值**: 提升用户个性化体验，增强社区归属感  
**技术复杂度**: ⭐⭐⭐  
**开发优先级**: P1 (高)

### 2. 盘名修改限制功能
**业务价值**: 防止恶意修改，维护社区秩序  
**技术复杂度**: ⭐⭐  
**开发优先级**: P2 (中)

### 3. 训练活动删除功能
**业务价值**: 完善管理员功能，提升管理效率  
**技术复杂度**: ⭐⭐⭐⭐  
**开发优先级**: P1 (高)

---

## 📊 开发优先级排序

### Phase 1: 核心功能完善 (第1-2周)
1. **训练活动删除功能** - 管理员急需功能
2. **用户头像管理功能** - 用户体验提升

### Phase 2: 业务规则完善 (第2-3周)
3. **盘名修改限制功能** - 业务规则完善

---

## 🔧 技术实现方案

### 1. 用户头像管理功能

#### 数据库设计变更
```javascript
// Users 集合新增字段
{
  customAvatarUrl: String,    // 自定义头像URL
  avatarType: String,         // 'wechat' | 'custom'
  avatarUpdateTime: Date,     // 头像更新时间
}
```

#### 技术方案
- **图片上传**: 使用 `wx.chooseImage` + `wx.cloud.uploadFile`
- **图片压缩**: 前端压缩 + 云端二次处理
- **存储方案**: 微信云存储，路径: `avatars/{openid}/{timestamp}.jpg`
- **格式限制**: JPG/PNG，最大2MB，压缩至200KB以下
- **安全控制**: 文件类型验证、大小限制、恶意文件检测

#### 开发任务拆分
1. **云存储配置** (0.5天)
   - 开通云存储服务
   - 配置存储权限和安全规则
   
2. **后端API开发** (1天)
   - 新增 `uploadAvatar` 云函数接口
   - 实现图片上传和URL更新逻辑
   
3. **前端功能开发** (1.5天)
   - 头像选择和上传组件
   - 图片压缩处理
   - 上传进度显示
   
4. **UI集成** (1天)
   - 个人中心页面集成
   - 头像显示逻辑更新
   
5. **测试验证** (0.5天)
   - 功能测试和边界情况验证

### 2. 盘名修改限制功能

#### 数据库设计变更
```javascript
// Users 集合新增字段
{
  discNameChangeCount: Number,    // 已修改次数，默认0
  discNameChangeHistory: Array,   // 修改历史记录
  lastDiscNameChangeTime: Date,   // 最后修改时间
}

// 修改历史记录结构
{
  oldName: String,
  newName: String,
  changeTime: Date,
  changeReason: String
}
```

#### 业务规则
- 每个用户最多修改3次盘名
- 修改间隔不少于24小时
- 记录完整的修改历史
- 超过限制后显示明确提示

#### 开发任务拆分
1. **数据库迁移** (0.5天)
   - 为现有用户添加新字段
   - 数据初始化脚本
   
2. **后端逻辑开发** (1天)
   - 修改 `user_service` 云函数
   - 添加修改次数验证逻辑
   
3. **前端界面开发** (1天)
   - 盘名修改页面
   - 剩余次数显示
   - 修改历史查看
   
4. **测试验证** (0.5天)
   - 边界情况测试

### 3. 训练活动删除功能

#### 数据库设计变更
```javascript
// Events 集合新增字段
{
  isDeleted: Boolean,           // 软删除标记
  deleteTime: Date,             // 删除时间
  deleteReason: String,         // 删除原因
  deletedBy: String,            // 删除操作者
}

// 新增 EventDeletionLogs 集合
{
  eventId: String,
  eventTitle: String,
  deleteTime: Date,
  deletedBy: String,
  deleteReason: String,
  affectedUsers: Array,         // 受影响的用户列表
  registrationCount: Number,    // 删除时的报名人数
}
```

#### 业务规则
- 只有管理员可以删除训练
- 训练开始前2小时内不允许删除
- 有报名用户的训练需要二次确认
- 提供"取消训练"和"删除训练"两种选项
- 删除后通知所有已报名用户

#### 开发任务拆分
1. **数据库设计** (0.5天)
   - 新增删除相关字段
   - 创建删除日志集合
   
2. **后端API开发** (2天)
   - 删除权限验证
   - 软删除逻辑实现
   - 用户通知机制
   
3. **前端功能开发** (1.5天)
   - 删除确认对话框
   - 删除原因选择
   - 操作结果反馈
   
4. **通知功能** (1天)
   - 删除通知模板
   - 批量通知发送
   
5. **测试验证** (1天)
   - 各种边界情况测试
   - 权限验证测试

---

## 🧪 测试策略

### 单元测试
- 云函数逻辑测试
- 数据验证测试
- 权限控制测试

### 集成测试
- 前后端接口测试
- 文件上传流程测试
- 删除流程完整性测试

### 用户验收测试
- 功能完整性验证
- 用户体验测试
- 性能压力测试

---

## 📈 成本评估

### 云存储成本
- 预估用户数: 100人
- 平均头像大小: 200KB
- 月存储成本: < 1元

### 开发时间成本
- 总开发时间: 12-15天
- 测试时间: 3-4天
- 总计: 15-19天

---

## 🚀 部署计划

### 灰度发布策略
1. 内部测试 (1-2天)
2. 小范围用户测试 (2-3天)
3. 全量发布

### 回滚方案
- 数据库备份策略
- 功能开关控制
- 快速回滚流程

---

## 📋 验收标准

### 功能验收
- [ ] 头像上传成功率 > 95%
- [ ] 盘名修改限制生效
- [ ] 训练删除功能正常
- [ ] 所有边界情况处理正确

### 性能验收
- [ ] 头像上传时间 < 5秒
- [ ] 页面响应时间 < 2秒
- [ ] 系统稳定性 > 99%

### 安全验收
- [ ] 文件上传安全验证
- [ ] 权限控制有效
- [ ] 数据完整性保证

---

## 📝 详细实现步骤

### Phase 1.1: 训练活动删除功能 (5天)

#### Day 1: 数据库设计和后端基础
**任务清单**:
- [ ] 设计 EventDeletionLogs 集合结构
- [ ] 为 Events 集合添加软删除字段
- [ ] 编写数据库迁移脚本
- [ ] 更新 event_service 云函数基础结构

**测试用例**:
```javascript
// 测试用例 1: 软删除标记
{
  input: { eventId: 'test-event-1', deleteReason: '活动取消' },
  expected: { isDeleted: true, deleteTime: Date, deleteReason: '活动取消' }
}

// 测试用例 2: 权限验证
{
  input: { userId: 'member-user', eventId: 'test-event-1' },
  expected: { success: false, message: '权限不足' }
}
```

#### Day 2: 删除业务逻辑开发
**任务清单**:
- [ ] 实现删除权限验证逻辑
- [ ] 开发时间限制检查 (训练前2小时)
- [ ] 实现报名用户检查逻辑
- [ ] 添加删除日志记录功能

**边界情况处理**:
- 训练已开始的情况
- 训练时间过近的情况
- 大量用户已报名的情况
- 网络异常导致的部分删除

#### Day 3: 前端删除界面开发
**任务清单**:
- [ ] 创建删除确认对话框组件
- [ ] 实现删除原因选择界面
- [ ] 添加二次确认机制
- [ ] 集成到训练详情页面

**UI设计要求**:
- 明确的删除警告提示
- 受影响用户数量显示
- 删除原因必填验证
- 操作结果清晰反馈

#### Day 4: 用户通知功能
**任务清单**:
- [ ] 设计通知消息模板
- [ ] 实现批量通知发送
- [ ] 添加通知发送状态跟踪
- [ ] 处理通知发送失败情况

#### Day 5: 测试和优化
**任务清单**:
- [ ] 完整功能测试
- [ ] 性能压力测试
- [ ] 边界情况验证
- [ ] 代码优化和文档更新

### Phase 1.2: 用户头像管理功能 (4天)

#### Day 1: 云存储配置和后端API
**任务清单**:
- [ ] 开通并配置微信云存储
- [ ] 设置存储安全规则
- [ ] 开发头像上传云函数接口
- [ ] 实现图片格式和大小验证

**安全配置**:
```javascript
// 云存储安全规则示例
{
  "read": true,
  "write": "auth.openid == resource.openid"
}
```

#### Day 2: 图片处理和压缩
**任务清单**:
- [ ] 实现前端图片压缩逻辑
- [ ] 添加图片质量优化
- [ ] 开发图片上传进度显示
- [ ] 处理上传失败重试机制

**技术参数**:
- 压缩目标: 200KB以下
- 支持格式: JPG, PNG
- 最大尺寸: 800x800px
- 压缩质量: 0.8

#### Day 3: 前端界面集成
**任务清单**:
- [ ] 创建头像选择组件
- [ ] 集成到个人中心页面
- [ ] 实现头像预览功能
- [ ] 添加上传状态反馈

#### Day 4: 测试和优化
**任务清单**:
- [ ] 各种图片格式测试
- [ ] 网络异常情况测试
- [ ] 用户体验优化
- [ ] 性能监控和优化

### Phase 2: 盘名修改限制功能 (3天)

#### Day 1: 数据结构和后端逻辑
**任务清单**:
- [ ] 为用户表添加修改次数字段
- [ ] 实现修改历史记录功能
- [ ] 开发修改次数验证逻辑
- [ ] 添加时间间隔限制

#### Day 2: 前端界面开发
**任务清单**:
- [ ] 创建盘名修改页面
- [ ] 显示剩余修改次数
- [ ] 实现修改历史查看
- [ ] 添加修改限制提示

#### Day 3: 测试和集成
**任务清单**:
- [ ] 修改次数限制测试
- [ ] 时间间隔验证测试
- [ ] 历史记录准确性测试
- [ ] 用户界面集成测试

---

## 🔍 详细测试用例

### 头像管理功能测试用例

#### 正常流程测试
```javascript
// TC001: 正常头像上传
{
  description: "用户选择图片并成功上传头像",
  steps: [
    "点击头像修改按钮",
    "选择相册图片",
    "确认上传",
    "等待上传完成"
  ],
  expected: "头像更新成功，显示新头像"
}

// TC002: 图片压缩测试
{
  description: "上传大尺寸图片自动压缩",
  input: "5MB的高清图片",
  expected: "压缩至200KB以下并上传成功"
}
```

#### 异常情况测试
```javascript
// TC003: 网络异常处理
{
  description: "上传过程中网络中断",
  steps: ["开始上传", "中断网络", "恢复网络"],
  expected: "显示上传失败，提供重试选项"
}

// TC004: 文件格式验证
{
  description: "上传不支持的文件格式",
  input: "GIF动图文件",
  expected: "显示格式不支持错误提示"
}
```

### 盘名修改限制测试用例

#### 正常流程测试
```javascript
// TC005: 首次修改盘名
{
  description: "用户首次修改盘名",
  precondition: "用户修改次数为0",
  steps: ["进入盘名修改页面", "输入新盘名", "确认修改"],
  expected: "修改成功，剩余次数显示为2"
}

// TC006: 达到修改限制
{
  description: "用户已修改3次后再次尝试修改",
  precondition: "用户修改次数为3",
  steps: ["进入盘名修改页面"],
  expected: "显示已达修改限制，禁用修改功能"
}
```

### 训练删除功能测试用例

#### 权限验证测试
```javascript
// TC007: 管理员删除权限
{
  description: "管理员删除自己创建的训练",
  precondition: "用户角色为admin",
  expected: "显示删除选项，可以执行删除"
}

// TC008: 普通用户权限限制
{
  description: "普通用户尝试删除训练",
  precondition: "用户角色为member",
  expected: "不显示删除选项或显示权限不足"
}
```

#### 业务规则测试
```javascript
// TC009: 时间限制验证
{
  description: "训练开始前1小时尝试删除",
  precondition: "当前时间距离训练开始1小时",
  expected: "显示时间过近，不允许删除"
}

// TC010: 有报名用户的删除确认
{
  description: "删除有10人报名的训练",
  precondition: "训练有10人已报名",
  steps: ["点击删除", "查看确认对话框"],
  expected: "显示将影响10名用户，需要二次确认"
}
```

---

## 📊 风险评估和应对策略

### 技术风险
1. **云存储配额超限**
   - 风险等级: 中
   - 应对策略: 实施图片压缩、定期清理、监控使用量

2. **图片上传失败率高**
   - 风险等级: 中
   - 应对策略: 重试机制、降级方案、用户提示

3. **数据库迁移风险**
   - 风险等级: 低
   - 应对策略: 充分测试、分步迁移、回滚方案

### 业务风险
1. **用户体验下降**
   - 风险等级: 中
   - 应对策略: 充分测试、用户反馈、快速修复

2. **功能滥用**
   - 风险等级: 低
   - 应对策略: 合理限制、监控机制、用户教育

---

**准备就绪**: 开发计划已制定完成，等待确认后开始实施
