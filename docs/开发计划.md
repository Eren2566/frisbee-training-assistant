好的，收到你的需求。作为一名资深的小程序技术架构师，我将为你分析这份架构文档，并制定一个详尽、可执行、阶梯式的开发计划。

这份计划严格遵循了逻辑依赖关系，将任务细化到可以直接作为编码指令的粒度，并为每个关键阶段设立了验证闭环。你可以按照这个计划，指导 AI 编码工具高效地完成开发工作。

---

### **飞盘队训练助手 - 阶梯式开发计划**

#### **第一阶段：环境准备与后端基础搭建**

此阶段的目标是建立项目的基本骨架，包括云开发环境的初始化和数据库结构的创建。这是所有后续开发的基础。

-   **[ ] 1. 项目与云环境初始化**
    -   [ ] 在微信公众平台注册小程序，获取 AppID。
    -   [ ] 使用“微信开发者工具”新建项目，选择“小程序项目”，并填入你的 AppID。
    -   [ ] 在开发者工具中开通“云开发”，并记录下你的“云开发环境 ID”。
    -   [ ] 在项目根目录的 `project.config.json` 文件中，填入 `"cloudfunctionRoot": "cloudfunctions/"` 和 `"env": "你的云开发环境ID"`。
    -   [ ] 在小程序根目录创建 `cloudfunctions` 文件夹，用于存放所有云函数。

-   **[ ] 2. 数据库集合（表）创建**
    -   [ ] 进入微信开发者工具的“云开发控制台” -> “数据库”。
    -   [ ] 创建集合 `Users`，并根据文档设置好权限规则（建议设置为“所有用户可读，仅创建者可读写”）。
    -   [ ] 创建集合 `Events`，并根据文档设置好权限规则（建议设置为“所有用户可读，仅管理员可写”）。
    -   [ ] 创建集合 `Registrations`，并根据文档设置好权限规则（建议设置为“所有用户可读，仅创建者可读写”）。

-   **[ ] 3. 核心云函数初始化**
    -   [ ] 在 `cloudfunctions` 目录下，右键新建 Node.js 云函数，命名为 `user_service`。
    -   [ ] 在 `cloudfunctions` 目录下，右键新建 Node.js 云函数，命名为 `event_service`。
    -   [ ] 在 `cloudfunctions` 目录下，右键新建 Node.js 云函数，命名为 `registration_service`。
    -   [ ] 分别右键对这三个云函数目录选择“上传并部署（所有文件）”，确保云函数环境就绪。

-   **[ ] 4. 阶段性验证**
    -   [ ] **验证点 1**: 项目能在模拟器中正常编译运行，没有关于环境配置的报错。
    -   [ ] **验证点 2**: 在云开发控制台中，可以看到 `Users`, `Events`, `Registrations` 三个集合已成功创建。
    -   [ ] **验证点 3**: 在云开发控制台的“云函数”页面，可以看到 `user_service`, `event_service`, `registration_service` 三个云函数状态正常。

---

#### **第二阶段：用户认证与身份模块开发**

此阶段完成小程序最基础的用户登录与角色识别功能，为后续区分“队长”和“队员”操作奠定基础。

-   **[ ] 1. 用户登录与信息注册**
    -   [ ] **编码任务 (后端)**: 编写 `user_service` 云函数，在其中添加一个名为 `login` 的入口。该函数逻辑为：
        1.  通过 `wx-server-sdk` 获取用户的 `_openid`。
        2.  查询 `Users` 集合，看该 `_openid` 是否已存在。
        3.  如果**不存在**，则在 `Users` 集合中插入一条新记录，包含 `_openid`, `nickName`, `avatarUrl`，并默认设置 `role` 为 `'member'`。
        4.  如果**存在**，则直接返回用户信息。
        5.  最终将完整的用户信息（包含 `role`）返回给前端。
    -   [ ] **编码任务 (前端)**: 创建 `pages/login/` 页面。
        1.  WXML: 放置一个授权按钮，用于获取用户昵称和头像。
        2.  JS: 在页面加载时，调用 `wx.login()` 获取 `code`，然后调用 `user_service` 的 `login` 云函数。成功后将返回的用户信息（特别是 `_openid` 和 `role`）存入全局 `app.globalData` 或本地缓存 `wx.setStorageSync`，并跳转到主页。

-   **[ ] 2. 管理员角色手动设定**
    -   [ ] **手动操作**: 为了测试，登录一次你自己的微信号，在 `Users` 集合中找到你的记录，手动将其 `role` 字段的值从 `'member'` 修改为 `'admin'`。

-   **[ ] 3. 阶段性验证**
    -   [ ] **验证点 1**: 新用户首次打开小程序，点击登录后，`Users` 集合中会新增一条 `role` 为 `'member'` 的记录。
    -   [ ] **验证点 2**: 已登录用户再次进入小程序，能静默登录并正确获取其用户信息。
    -   [ ] **验证点 3**: 将自己的 `role` 修改为 `'admin'` 后，重新登录，验证全局变量中获取到的角色是否为 `'admin'`。

---

#### **第三阶段：核心业务流程开发 (队长端)**

此阶段聚焦于管理员（队长）的核心功能：创建和管理训练。

-   **[ ] 1. 创建训练功能**
    -   [ ] **编码任务 (后端)**: 编写 `event_service` 云函数，添加 `create` 入口。逻辑如下：
        1.  获取调用者的 `_openid`，查询 `Users` 表验证其 `role` 是否为 `'admin'`。若不是，则返回权限错误。
        2.  接收前端传来的 `title`, `eventTime`, `location`, `content` 等数据。
        3.  组合数据，补充 `creatorId` (调用者 `_openid`) 和默认 `status: 'registering'`。
        4.  将完整的对象插入到 `Events` 集合。
    -   [ ] **编码任务 (前端)**: 创建 `pages/admin/create-event/` 页面。
        1.  WXML: 构建一个表单，包含标题、时间选择器、地点、内容描述等输入框。
        2.  JS: 处理表单提交，调用 `event_service` 的 `create` 云函数，并根据返回结果给出“发布成功”或“失败”的提示。

-   **[ ] 2. 训练列表与管理入口**
    -   [ ] **编码任务 (后端)**: 编写 `event_service` 云函数，添加 `getList` 入口，用于查询并返回 `Events` 集合中的所有记录，按 `eventTime` 降序排列。
    -   [ ] **编码任务 (前端)**: 创建 `pages/event-list/` 页面。
        1.  JS: 在页面加载时，调用 `event_service` 的 `getList` 云函数获取数据。
        2.  WXML: 循环渲染训练列表。
        3.  JS/WXML: 从全局数据中判断当前用户角色，如果 `role` 为 `'admin'`，则在页面上显示一个“发布新训练”的按钮，点击后跳转到 `pages/admin/create-event/`。

-   **[ ] 3. 阶段性验证**
    -   [ ] **验证点 1**: 使用普通队员账号，“发布新训练”按钮不可见。
    -   [ ] **验证点 2**: 使用队长账号，可以进入创建页面，并成功发布一条新的训练。`Events` 集合中出现对应数据。
    -   [ ] **验证点 3**: 任何角色的用户都能在 `pages/event-list/` 页面上看到已发布的训练列表。

---

#### **第四阶段：核心业务流程开发 (队员端)**

此阶段完成队员的核心操作：报名、请假，并能查看自己的状态。

-   **[ ] 1. 用户报名/请假功能**
    -   [ ] **编码任务 (后端)**: 编写 `registration_service` 云函数，添加 `register` 入口。逻辑如下：
        1.  接收前端传来的 `eventId` 和 `status` (`'signed_up'` 或 `'leave_requested'`)。
        2.  获取调用者的 `_openid` (`userId`)。
        3.  **重要**: 查询 `Registrations` 集合，检查 `eventId` 和 `userId` 组合的记录是否已存在，防止重复操作。
        4.  若不存在，则将 `eventId`, `userId`, `status` 插入到 `Registrations` 集合。
    -   [ ] **编码任务 (前端)**: 创建 `pages/event-detail/[id]` 页面。
        1.  JS: 页面加载时，通过 `options` 获取 `eventId`，并调用云函数获取训练详情和该用户在此活动下的报名状态。
        2.  WXML: 显示训练的详细信息。下方根据用户的报名状态显示不同的按钮组（如“我要报名/我要请假”或“已报名/已请假”）。
        3.  JS: 为按钮绑定事件，调用 `registration_service` 的 `register` 云函数，并实时更新页面状态。

-   **[ ] 2. 阶段性验证**
    -   [ ] **验证点 1**: 队员可以查看训练详情，并成功报名或请假。
    -   [ ] **验证点 2**: `Registrations` 集合中成功创建了对应的记录。
    -   [ ] **验证点 3**: 同一个队员无法对同一个活动重复报名。
    -   [ ] **验证点 4**: 队员操作成功后，详情页的按钮状态会立刻更新。

---

#### **第五阶段：业务闭环与联调测试**

此阶段将队长的“确认出勤”功能与队员的报名功能连接起来，形成完整的业务闭环，并进行端到端测试。

-   **[ ] 1. 队长确认出勤功能**
    -   [ ] **编码任务 (后端)**: 编写 `registration_service` 云函数，添加 `getListByEvent` 入口，接收 `eventId`，返回该活动所有报名记录，并附带用户信息（通过数据库联查 `Users` 表）。
    -   [ ] **编码任务 (后端)**: 编写 `registration_service` 云函数，添加 `updateAttendance` 入口。逻辑如下：
        1.  验证调用者是否为 `admin`。
        2.  接收 `registrationId` 和新的 `status` (`'present'` 或 `'absent'`)。
        3.  更新 `Registrations` 集合中对应记录的 `status` 字段。
    -   [ ] **编码任务 (前端)**: 增强 `pages/event-detail/[id]` 页面。
        1.  JS: 如果当前用户是 `admin`，则在获取完活动详情后，额外调用 `registration_service` 的 `getListByEvent` 函数，获取报名列表。
        2.  WXML: 在页面下方渲染报名人员列表（显示头像、昵称、报名状态）。在每个“已报名”的队员旁，放置“出勤”和“缺勤”按钮。
        3.  JS: 为按钮绑定事件，调用 `registration_service` 的 `updateAttendance` 云函数，并实时刷新列表。

-   **[ ] 2. 个人出勤统计**
    -   [ ] **编码任务 (后端)**: 在 `registration_service` 中添加 `getMyList` 入口，根据调用者 `_openid` 查询其所有报名记录。
    -   [ ] **编码任务 (前端)**: 创建 `pages/my-profile/` 页面，显示一个“我的出勤”入口，点击后跳转到新页面，调用 `getMyList` 并展示该用户的所有活动参与历史。

-   **[ ] 3. 阶段性验证 (端到端测试)**
    -   [ ] **测试场景 1 (完整流程)**:
        1.  队长账号 **创建** 一个新训练。
        2.  队员账号 **报名** 该训练。
        3.  队长账号在详情页**看到**了队员的报名记录。
        4.  队长账号将该队员标记为 **“出勤”**。
        5.  队员账号在“我的出勤”页面中，**看到**该次训练的状态更新为“已出勤”。
    -   [ ] **测试场景 2 (权限)**: 队员账号无法看到管理入口（如出勤/缺勤按钮）。

---

#### **第六阶段：优化、部署与上线**

完成所有核心功能后，进行最终的优化和发布准备。

-   [ ] **[ ] 1. 全局体验优化**
    -   [ ] 在所有调用云函数的地方，添加 `wx.showLoading` 和 `wx.hideLoading`，提供加载反馈。
    -   [ ] 对所有云函数调用的失败情况，添加 `wx.showToast` 进行友好的错误提示。
    -   [ ] 检查所有页面的 UI/UX，确保样式统一、交互流畅。
-   [ ] **[ ] 2. 代码审查与清理**
    -   [ ] 删除开发过程中的测试代码和 `console.log`。
    -   [ ] 优化云函数和前端代码，提取可复用的组件或工具函数。
-   [ ] **[ ] 3. 提交发布**
    -   [ ] 在开发者工具中，点击“上传”，填写版本信息。
    -   [ ] 登录微信公众平台，在“版本管理”中将刚上传的版本提交审核。

-   **[ ] 4. 阶段性验证**
    -   [ ] **验证点 1**: 所有功能在真机上运行正常。
    -   [ ] **验证点 2**: 小程序成功通过微信团队的审核并上架。