# 头像管理功能使用说明

## 📋 功能概述

用户头像管理功能允许用户上传自定义头像，替换默认的微信头像。

### 主要特性
- ✅ 支持从相册选择或拍照上传
- ✅ 自动图片压缩优化
- ✅ 云存储安全保存
- ✅ 简洁的用户界面

## 🚀 部署步骤

### 1. 部署云函数
在微信开发者工具中：
1. 右键 `cloudfunctions/user_service` 目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 2. 开通云存储
1. 在微信开发者工具中打开"云开发控制台"
2. 点击"存储"选项卡
3. 如果未开通，点击"开通存储"
4. 确认开通云存储服务

### 3. 运行数据库迁移（可选）
如果是现有项目，需要为用户添加头像字段：
1. 在云开发控制台的"云函数"中创建临时云函数
2. 复制 `scripts/migrate-avatar-fields.js` 的内容
3. 运行迁移脚本

## 💡 使用方法

### 用户端操作
1. 打开小程序，进入"我的"页面
2. 点击头像区域
3. 选择"从相册选择"或"拍照"
4. 等待上传完成
5. 头像自动更新显示

### 技术细节
- **存储路径**: `avatars/{openid}_{timestamp}.jpg`
- **文件大小**: 自动压缩，通常 < 200KB
- **支持格式**: JPG, PNG
- **上传超时**: 30秒

## 🧪 测试验证

### 1. 功能测试
在微信开发者工具控制台中运行：
```javascript
// 加载测试脚本
const testScript = require('./scripts/test-avatar-upload.js')

// 运行所有测试
testScript.runAllTests()
```

### 2. 手动测试
1. 登录小程序
2. 进入个人中心页面
3. 点击头像进行上传测试
4. 验证头像是否正确显示

## 🔧 故障排除

### 常见问题

#### 1. 上传失败
**可能原因**：
- 云存储未开通
- 网络连接问题
- 图片格式不支持

**解决方案**：
- 确认云存储已开通
- 检查网络连接
- 使用JPG或PNG格式图片

#### 2. 头像不显示
**可能原因**：
- 云函数未部署
- 数据库字段缺失
- 缓存问题

**解决方案**：
- 重新部署云函数
- 运行数据库迁移脚本
- 清除小程序缓存重新登录

#### 3. 上传速度慢
**可能原因**：
- 图片文件过大
- 网络环境不佳

**解决方案**：
- 选择较小的图片
- 在网络良好时上传

## 📊 性能指标

### 预期性能
- **上传成功率**: > 95%
- **上传时间**: < 5秒（正常网络）
- **图片压缩率**: 通常压缩至原大小的20-30%
- **存储成本**: 100用户约0.5元/月

### 监控建议
- 定期检查云存储使用量
- 监控上传失败率
- 关注用户反馈

## 🔒 安全考虑

### 数据安全
- 头像文件存储在微信云存储中
- 仅用户本人可以修改自己的头像
- 自动清理临时文件

### 隐私保护
- 不会获取用户相册中的其他图片
- 仅在用户主动操作时上传
- 遵循微信小程序隐私规范

## 📈 后续优化

### 可能的改进
1. **头像裁剪功能** - 允许用户裁剪上传的图片
2. **头像历史** - 保存用户的历史头像
3. **批量压缩** - 进一步优化图片大小
4. **CDN加速** - 提升头像加载速度

### 扩展功能
- 头像框架选择
- 头像特效滤镜
- 团队头像模板

---

**注意**: 此功能需要微信小程序基础库版本 >= 2.10.0
