### **飞盘队训练助手：架构设计与核心开发文档**

**版本:** 1.0 (MVP)
**撰写人:** eren
**日期:** 2025年7月9日

---

## **1. 总体架构设计**

为了实现快速开发、简化运维和无缝的微信生态集成，我们选择 **微信原生小程序 + 微信云开发** 作为核心技术架构。这是一个典型的 Serverless（无服务器）架构，极大地降低了初期开发的复杂度和成本。

### **1.1 技术架构选型**

*   **前端:** 微信原生小程序。使用 WXML + WXSS + JavaScript 进行开发，能够最大化地利用微信提供的原生能力，如微信登录、消息通知等，保证最佳的用户体验和性能。
*   **后端:** 微信云开发 (WeChat Cloud Base)。这是一个由微信官方提供的一站式后端云服务，它包含以下核心组件，构成了我们的整个后端：
    *   **云函数 (Cloud Functions):** 我们的核心业务逻辑（如创建训练、报名、确认出勤）将通过云函数实现。前端小程序通过 API 调用云函数，云函数再对数据库进行操作。这避免了自建服务器、配置域名和处理 SSL 证书的麻烦。
    *   **云数据库 (Cloud Database):** 一个基于 NoSQL (MongoDB) 的 JSON 文档数据库，用于存储所有业务数据，如用户信息、训练活动和报名记录。其灵活的文档结构非常适合项目初期的快速迭代。
    *   **云存储 (Cloud Storage):** (备用) 虽然 MVP 阶段不强制要求，但未来可用于存储用户头像、训练相关的图片等文件。

### **1.2 系统架构图**

```
┌─────────────────────────────────────────────────────────────┐
│                    微信小程序前端                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   队员端     │  │   队长端     │  │   通用组件   │          │
│  │             │  │             │  │             │          │
│  │ • 活动浏览   │  │ • 训练管理   │  │ • 登录授权   │          │
│  │ • 报名/请假  │  │ • 报名管理   │  │ • 用户信息   │          │
│  │ • 出勤统计   │  │ • 出勤管理   │  │ • 通用工具   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 云函数调用
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    微信云开发后端                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   云函数     │  │   云数据库   │  │   云存储     │          │
│  │             │  │             │  │             │          │
│  │ • 用户管理   │  │ • users     │  │ • 用户头像   │          │
│  │ • 训练管理   │  │ • events    │  │ • 活动图片   │          │
│  │ • 报名管理   │  │ • registra- │  │             │          │
│  │ • 出勤管理   │  │   tions     │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 核心模块划分

**前端模块：**
- **用户认证模块**：处理微信登录、用户信息获取
- **训练管理模块**：队长端的训练创建、编辑、发布功能
- **报名管理模块**：队员报名、请假，队长查看报名统计
- **出勤管理模块**：队长现场确认出勤，队员查看出勤记录

**后端模块：**
- **身份验证云函数**：处理用户登录、权限验证
- **训练业务云函数**：训练的CRUD操作
- **报名业务云函数**：报名、请假的处理逻辑
- **出勤业务云函数**：出勤状态的更新和统计
---

## **2. 数据库核心表设计**

我们将使用云数据库的集合 (Collections) 来存储数据。以下是三个核心集合的结构设计：

### **2.1 用户表 (Users)**

存储小程序所有用户的基本信息和角色。

| 字段名 (Field) | 数据类型 (Type) | 说明                                            |
| :------------- | :-------------- | :---------------------------------------------- |
| `_openid`      | `String`        | **主键**。用户在小程序下的唯一标识，自动获取。  |
| `nickName`     | `String`        | 用户昵称。                                      |
| `avatarUrl`    | `String`        | 用户头像的 URL。                                |
| `role`         | `String`        | 用户角色。枚举值：`'admin'` (管理员), `'member'` (队员)。 |
| `createTime`   | `Date`          | 用户首次授权登录的时间。                          |

### **2.2 训练表 (Events)**

存储由队长创建的每一次训练活动。

| 字段名 (Field)  | 数据类型 (Type) | 说明                                                            |
| :-------------- | :-------------- | :-------------------------------------------------------------- |
| `_id`           | `String`        | **主键**。云数据库自动生成的唯一 ID。                           |
| `creatorId`     | `String`        | 创建者 `_openid`，用于关联 `Users` 表。                         |
| `title`         | `String`        | 训练主题，例如“基础传接盘练习”。                                |
| `eventTime`     | `Date`          | 训练开始的日期和时间。                                          |
| `location`      | `String`        | 训练地点。                                                      |
| `content`       | `String`        | 详细的训练内容描述。                                            |
| `notes`         | `String`        | 备注信息，可选。                                                |
| `status`        | `String`        | 活动状态。枚举值：`'registering'` (报名中), `'finished'` (已结束)。 |
| `createTime`    | `Date`          | 记录创建时间。                                                  |
| `updateTime`    | `Date`          | 记录最后修改时间。                                              |

### **2.3 报名/出勤表 (Registrations)**

记录队员对每一次训练的报名和最终出勤情况。

| 字段名 (Field) | 数据类型 (Type) | 说明                                                                                    |
| :------------- | :-------------- | :-------------------------------------------------------------------------------------- |
| `_id`          | `String`        | **主键**。云数据库自动生成的唯一 ID。                                                   |
| `eventId`      | `String`        | 关联的训练 `_id`。                                                                      |
| `userId`       | `String`        | 报名的队员 `_openid`。                                                                  |
| `status`       | `String`        | 报名/出勤状态。枚举值：`'signed_up'` (已报名), `'leave_requested'` (已请假), `'present'` (已出勤), `'absent'` (已缺勤)。 |
| `createTime`   | `Date`          | 报名或请假操作的时间。                                                                  |
| `updateTime`   | `Date`          | 状态更新时间（例如，队长标记出勤时）。                                                  |

**约束:** `eventId` 和 `userId` 的组合应该是唯一的，以防止同一用户对同一活动重复报名。

---

## **3. 核心功能模块实现逻辑**

### **3.1 流程一：创建训练 (管理员)**

1.  **前端:** 管理员（队长）在小程序中进入“创建训练”页面，填写表单（主题、时间、地点等）。
2.  **API 调用:** 点击“发布”按钮后，前端调用名为 `createEvent` 的云函数，并将表单数据作为参数传递。
3.  **云函数 (`createEvent`):**
    *   **权限校验:** 从函数上下文获取调用者的 `_openid`，查询 `Users` 表，验证其 `role` 是否为 `'admin'`。如果不是，则直接返回错误。
    *   **数据写入:** 权限验证通过后，将接收到的训练数据与 `creatorId`（调用者的 `_openid`）、`createTime`、`status: 'registering'` 等字段组合成一个新对象。
    *   **数据库操作:** 调用数据库 `add` 方法，将新对象插入到 `Events` 集合中。
4.  **返回与刷新:** 函数执行成功后，向前端返回成功状态。前端收到后，提示“发布成功”并跳转到活动列表页，刷新列表。

### **3.2 流程二：用户报名/请假 (队员)**

1.  **前端:** 队员在小程序主页看到“即将开始”的训练活动列表（通过调用 `getEventList` 云函数获取）。
2.  **API 调用:** 点击某个活动的“报名”或“请假”按钮。前端调用名为 `registerForEvent` 的云函数，并传递 `eventId` 和操作类型（例如 `status: 'signed_up'`）。
3.  **云函数 (`registerForEvent`):**
    *   **获取用户信息:** 从上下文获取调用者的 `_openid`。
    *   **防止重复:** 查询 `Registrations` 表，检查是否已存在 `eventId` 和 `userId` (调用者 `_openid`) 相同的记录。如果存在，则返回“请勿重复报名”的提示。
    *   **数据写入:** 如果不存在重复记录，则构造一个新的报名对象，包含 `eventId`、`userId` 和传入的 `status`。
    *   **数据库操作:** 调用数据库 `add` 方法，将该对象插入到 `Registrations` 集合中。
4.  **返回与刷新:** 函数执行成功后，向前端返回成功状态。前端收到后，更新该活动按钮的状态（例如，变为“已报名”）。

### **3.3 流程三：队长确认出勤 (管理员)**

1.  **前端:** 训练现场，队长打开对应训练的详情页。页面会展示所有“已报名”和“已请假”的队员列表（通过调用 `getRegistrationList` 云函数并传入 `eventId` 获取）。
2.  **API 调用:** 队长点击某队员旁的“出勤”或“缺勤”按钮。前端调用名为 `updateAttendance` 的云函数，并传递该队员对应的 `registrationId` 和新的状态（`'present'` 或 `'absent'`）。
3.  **云函数 (`updateAttendance`):**
    *   **权限校验:** 再次验证调用者是否为 `'admin'`，确保操作安全。
    *   **数据更新:** 权限通过后，使用传入的 `registrationId` 作为查询条件。
    *   **数据库操作:** 调用数据库 `update` 方法，将 `Registrations` 集合中对应记录的 `status` 字段更新为新状态，并更新 `updateTime`。
4.  **返回与刷新:** 函数执行成功后，返回成功状态。前端收到后，实时刷新出勤列表，更新该队员的状态显示。

---

## **4. 技术选型建议与理由**

### 4.1 前端技术选型

**微信原生小程序**
- **性能优势**：原生渲染，响应速度快，用户体验流畅
- **开发效率**：微信提供完整的开发工具链，调试便捷
- **功能集成**：天然集成微信登录、分享等社交功能
- **维护成本**：无需考虑多端兼容性问题，专注业务逻辑

### 4.2 后端技术选型

**微信云开发**
- **零运维成本**：无需服务器运维，自动扩缩容
- **开发便捷**：与小程序深度集成，减少配置复杂度
- **安全可靠**：自动处理用户身份验证，数据传输加密
- **成本可控**：按量付费模式，初期成本极低

**云函数架构**
- **按需执行**：仅在被调用时运行，节省资源
- **自动扩展**：根据请求量自动调整计算资源
- **版本管理**：支持灰度发布，降低上线风险
- **监控完善**：提供详细的运行日志和性能监控

### 4.3 数据库选型

**云数据库（MongoDB）**
- **文档型结构**：适合小程序的JSON数据格式
- **灵活的数据模型**：支持嵌套结构，便于扩展
- **实时数据库**：支持数据实时同步，提升用户体验
- **权限控制**：基于用户身份的细粒度权限管理

### 4.4 MVP策略优势

当前技术选型完美契合MVP理念，通过**微信原生小程序 + 云开发**的组合，可以实现：

- **快速上线**：从开发到发布，整个周期可控制在2-3周内
- **低成本试错**：云开发的按量付费模式，让初期验证成本极低
- **易于迭代**：云函数的独立部署特性，支持功能的快速迭代
- **用户体验优先**：原生小程序保证了最佳的用户交互体验