<!--盘名修改页面-->
<view class="container">
  <!-- 页面标题 -->
  <view class="header">
    <text class="title">修改盘名</text>
    <text class="subtitle">飞盘昵称，展现你的个性</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 主要内容 -->
  <view class="content" wx:else>
    <!-- 当前状态卡片 -->
    <view class="card status-card">
      <view class="status-header">
        <text class="current-name">当前盘名：{{currentDiscName || '未设置'}}</text>
        <view class="remaining-badge {{remainingChanges === 0 ? 'exhausted' : ''}}">
          <text>剩余 {{remainingChanges}} 次</text>
        </view>
      </view>
      
      <view class="status-info">
        <text class="info-text">每个用户最多可以修改3次盘名</text>
        <text class="info-text" wx:if="{{lastChangeTime}}">
          上次修改：{{formatTime(lastChangeTime)}}
        </text>
      </view>
    </view>

    <!-- 修改表单 -->
    <view class="card form-card" wx:if="{{canChange}}">
      <view class="form-header">
        <text class="form-title">设置新盘名</text>
      </view>
      
      <view class="form-content">
        <view class="input-group">
          <input 
            class="disc-name-input" 
            placeholder="请输入新的盘名（2-20个字符）"
            value="{{newDiscName}}"
            bindinput="onDiscNameInput"
            maxlength="20"
            confirm-type="done"
            bindconfirm="confirmChange"
          />
          <view class="input-counter">
            <text>{{newDiscName.length}}/20</text>
          </view>
        </view>
        
        <view class="input-tips">
          <text class="tip-item">• 支持中文、英文、数字</text>
          <text class="tip-item">• 长度为2-20个字符</text>
          <text class="tip-item">• 不能包含特殊符号</text>
        </view>
      </view>
      
      <view class="form-actions">
        <button 
          class="btn btn-primary" 
          bindtap="confirmChange"
          disabled="{{!canSubmit || isSubmitting}}"
          loading="{{isSubmitting}}"
        >
          {{isSubmitting ? '修改中...' : '确认修改'}}
        </button>
      </view>
    </view>

    <!-- 已达到限制提示 -->
    <view class="card limit-card" wx:else>
      <view class="limit-content">
        <view class="limit-icon">⚠️</view>
        <text class="limit-title">已达到修改次数限制</text>
        <text class="limit-desc">您已经修改了3次盘名，无法再次修改</text>
      </view>
    </view>

    <!-- 修改历史 -->
    <view class="card history-card" wx:if="{{changeHistory.length > 0}}">
      <view class="history-header" bindtap="toggleHistory">
        <text class="history-title">修改历史 ({{changeHistory.length}})</text>
        <text class="toggle-icon">{{showHistory ? '▼' : '▶'}}</text>
      </view>
      
      <view class="history-content" wx:if="{{showHistory}}">
        <view class="history-item" wx:for="{{changeHistory}}" wx:key="index">
          <view class="history-main">
            <text class="history-change">
              {{item.oldName || '未设置'}} → {{item.newName}}
            </text>
            <text class="history-time">{{formatTime(item.changeTime)}}</text>
          </view>
          <text class="history-reason">{{item.changeReason}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
