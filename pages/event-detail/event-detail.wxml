<!--pages/event-detail/event-detail.wxml-->
<view class="page">
  <!-- è®­ç»ƒè¯¦æƒ…å¡ç‰‡ -->
  <view class="card event-detail-card" wx:if="{{eventDetail}}">
    <!-- è®­ç»ƒæ ‡é¢˜å’ŒçŠ¶æ€ -->
    <view class="event-header">
      <text class="event-title">{{eventDetail.title}}</text>
      <view class="event-status {{eventDetail.status}}">
        <text>{{eventDetail.status === 'registering' ? 'æŠ¥åä¸­' : 'å·²ç»“æŸ'}}</text>
      </view>
    </view>

    <!-- è®­ç»ƒåŸºæœ¬ä¿¡æ¯ -->
    <view class="event-info">
      <view class="info-item">
        <text class="info-icon icon icon-time icon-gradient-secondary icon-lg"></text>
        <text class="info-label">è®­ç»ƒæ—¶é—´</text>
        <text class="info-value">{{eventDetail.formattedTime}}</text>
      </view>

      <view class="info-item">
        <text class="info-icon icon icon-location icon-gradient-secondary icon-lg"></text>
        <text class="info-label">è®­ç»ƒåœ°ç‚¹</text>
        <text class="info-value">{{eventDetail.location}}</text>
      </view>
    </view>

    <!-- è®­ç»ƒå†…å®¹ -->
    <view class="event-content" wx:if="{{eventDetail.content}}">
      <text class="content-title">è®­ç»ƒå†…å®¹</text>
      <text class="content-text">{{eventDetail.content}}</text>
    </view>

    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    <view class="event-notes" wx:if="{{eventDetail.notes}}">
      <text class="notes-title">å¤‡æ³¨</text>
      <text class="notes-text">{{eventDetail.notes}}</text>
    </view>
  </view>

  <!-- å‚è®­äººå‘˜å¡ç‰‡ -->
  <view class="card participants-card" wx:if="{{eventDetail}}">
    <text class="section-title">å‚è®­äººå‘˜</text>

    <!-- å‚è®­äººå‘˜åˆ—è¡¨ -->
    <view class="participants-list" wx:if="{{registrationList.length > 0}}">
      <view class="participant-item"
            wx:for="{{registrationList}}"
            wx:key="_id"
            wx:if="{{item.status === 'signed_up'}}">

        <!-- æ€§åˆ«æ ‡è¯† -->
        <view class="gender-badge {{item.userInfo.gender === 'ç”·' ? 'male' : 'female'}}">
          <text>{{item.userInfo.gender || 'æœªçŸ¥'}}</text>
        </view>

        <!-- ç›˜åæ˜¾ç¤º -->
        <view class="participant-name">
          <text>{{item.userInfo.discName || item.userInfo.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
        </view>
      </view>
    </view>

    <!-- æ— å‚è®­äººå‘˜æç¤º -->
    <view class="empty-participants" wx:if="{{registrationList.length === 0 || !hasSignedUpUsers}}">
      <text class="empty-text">æš‚æ— å‚è®­äººå‘˜</text>
    </view>
  </view>

  <!-- ç”¨æˆ·æ“ä½œåŒºåŸŸ -->
  <view class="card user-actions" wx:if="{{!isAdmin && eventDetail && eventDetail.status === 'registering'}}">
    <text class="section-title">æˆ‘çš„çŠ¶æ€</text>
    
    <!-- ç”¨æˆ·å½“å‰çŠ¶æ€æ˜¾ç¤º -->
    <view class="current-status" wx:if="{{userStatus}}">
      <text class="status-text">å½“å‰çŠ¶æ€ï¼š</text>
      <view class="status-badge {{userStatus.status}}">
        <text>{{userStatus.status === 'signed_up' ? 'å·²æŠ¥å' : userStatus.status === 'leave_requested' ? 'å·²è¯·å‡' : 'æœªçŸ¥'}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons" wx:if="{{!userStatus}}">
      <button 
        class="btn-primary register-btn" 
        bindtap="registerForEvent"
        data-status="signed_up"
        disabled="{{isRegistering}}"
      >
        {{isRegistering ? 'å¤„ç†ä¸­...' : 'æˆ‘è¦æŠ¥å'}}
      </button>
      
      <button 
        class="btn-secondary leave-btn" 
        bindtap="registerForEvent"
        data-status="leave_requested"
        disabled="{{isRegistering}}"
      >
        {{isRegistering ? 'å¤„ç†ä¸­...' : 'æˆ‘è¦è¯·å‡'}}
      </button>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜æŠ¥åç®¡ç†åŒºåŸŸ -->
  <view class="card admin-panel" wx:if="{{isAdmin}}">
    <view class="admin-header">
      <text class="section-title">æŠ¥åç®¡ç†</text>
      <button
        class="btn-danger btn-mini delete-event-btn"
        bindtap="showDeleteConfirm"
        wx:if="{{canDeleteEvent}}"
      >
        åˆ é™¤è®­ç»ƒ
      </button>
    </view>
    
    <!-- æŠ¥åç»Ÿè®¡ -->
    <view class="registration-stats">
      <view class="stat-item">
        <text class="stat-number">{{registrationStats.total}}</text>
        <text class="stat-label">æ€»æŠ¥å</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{registrationStats.signedUp}}</text>
        <text class="stat-label">å·²æŠ¥å</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{registrationStats.leaveRequested}}</text>
        <text class="stat-label">å·²è¯·å‡</text>
      </view>
    </view>

    <!-- æŠ¥ååˆ—è¡¨ -->
    <view class="registration-list" wx:if="{{registrationList.length > 0}}">
      <view class="list-item" 
            wx:for="{{registrationList}}" 
            wx:key="_id">
        
        <view class="member-info">
          <image class="member-avatar" src="{{item.userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view class="member-details">
            <text class="member-name">{{item.userInfo.discName || item.userInfo.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
            <view class="member-status {{item.status}}">
              <text>{{item.status === 'signed_up' ? 'å·²æŠ¥å' : item.status === 'leave_requested' ? 'å·²è¯·å‡' : item.status === 'present' ? 'å·²å‡ºå‹¤' : item.status === 'absent' ? 'ç¼ºå‹¤' : 'æœªçŸ¥'}}</text>
            </view>
          </view>
        </view>

        <!-- ç®¡ç†å‘˜æ“ä½œæŒ‰é’® -->
        <view class="admin-actions" wx:if="{{item.status === 'signed_up'}}">
          <button 
            class="btn-mini btn-success" 
            bindtap="updateAttendance"
            data-id="{{item._id}}"
            data-status="present"
          >
            å‡ºå‹¤
          </button>
          <button 
            class="btn-mini btn-danger" 
            bindtap="updateAttendance"
            data-id="{{item._id}}"
            data-status="absent"
          >
            ç¼ºå‹¤
          </button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-registration" wx:else>
      <text class="empty-text">æš‚æ— æŠ¥åè®°å½•</text>
    </view>
  </view>

  <!-- åˆ é™¤è®­ç»ƒç¡®è®¤å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showDeleteModal}}" bindtap="hideDeleteModal">
    <view class="modal-content delete-modal" catchtap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="modal-header delete-header">
        <view class="header-icon">
          <text class="delete-icon">ğŸ—‘ï¸</text>
        </view>
        <view class="header-text">
          <text class="modal-title">åˆ é™¤è®­ç»ƒç¡®è®¤</text>
          <text class="modal-subtitle">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ</text>
        </view>
        <text class="modal-close" bindtap="hideDeleteModal">Ã—</text>
      </view>

      <view class="modal-body">
        <!-- è­¦å‘Šæç¤ºåŒºåŸŸ -->
        <view class="warning-section">
          <view class="warning-badge">
            <text class="warning-icon">âš ï¸</text>
            <text class="warning-text">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®­ç»ƒæ´»åŠ¨å—ï¼Ÿ</text>
          </view>
        </view>

        <!-- è®­ç»ƒä¿¡æ¯å¡ç‰‡ -->
        <view class="event-info-card">
          <view class="event-basic-info">
            <view class="info-row">
              <text class="info-label">è®­ç»ƒåç§°</text>
              <text class="info-value">{{eventDetail.title}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">è®­ç»ƒæ—¶é—´</text>
              <text class="info-value">{{eventDetail.formattedTime}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">è®­ç»ƒåœ°ç‚¹</text>
              <text class="info-value">{{eventDetail.location}}</text>
            </view>
          </view>
        </view>

        <!-- æŠ¥åå½±å“ç»Ÿè®¡ -->
        <view class="impact-section" wx:if="{{registrationStats.total > 0}}">
          <view class="section-header">
            <text class="section-title">åˆ é™¤å½±å“</text>
            <text class="total-count">å…± {{registrationStats.total}} äºº</text>
          </view>

          <view class="stats-grid">
            <view class="stat-item" wx:if="{{registrationStats.signedUp > 0}}">
              <view class="stat-icon signed-up">ğŸ‘¥</view>
              <view class="stat-info">
                <text class="stat-number">{{registrationStats.signedUp}}</text>
                <text class="stat-label">å·²æŠ¥å</text>
              </view>
            </view>

            <view class="stat-item" wx:if="{{registrationStats.leaveRequested > 0}}">
              <view class="stat-icon leave-requested">ğŸ </view>
              <view class="stat-info">
                <text class="stat-number">{{registrationStats.leaveRequested}}</text>
                <text class="stat-label">å·²è¯·å‡</text>
              </view>
            </view>

            <view class="stat-item" wx:if="{{registrationStats.present > 0}}">
              <view class="stat-icon present">âœ…</view>
              <view class="stat-info">
                <text class="stat-number">{{registrationStats.present}}</text>
                <text class="stat-label">å·²å‡ºå‹¤</text>
              </view>
            </view>
          </view>

          <view class="impact-notice">
            <text class="notice-text">åˆ é™¤åå°†è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰æŠ¥åç”¨æˆ·</text>
          </view>
        </view>

        <!-- æ—¶é—´é™åˆ¶æé†’ -->
        <view class="time-limit-section">
          <view class="limit-badge">
            <text class="limit-icon">â°</text>
            <text class="limit-text">è®­ç»ƒå¼€å§‹å‰2å°æ—¶å†…å°†æ— æ³•åˆ é™¤</text>
          </view>
        </view>

        <!-- åˆ é™¤åŸå› è¾“å…¥åŒºåŸŸ -->
        <view class="delete-reason-section">
          <view class="reason-header">
            <text class="reason-label">åˆ é™¤åŸå› </text>
            <text class="reason-optional">ï¼ˆå¯é€‰ï¼‰</text>
          </view>

          <!-- é¢„è®¾åŸå› é€‰é¡¹ -->
          <view class="reason-presets">
            <view
              class="preset-item {{deleteReason === 'å¤©æ°”åŸå› å–æ¶ˆ' ? 'active' : ''}}"
              bindtap="selectPresetReason"
              data-reason="å¤©æ°”åŸå› å–æ¶ˆ"
            >
              <text class="preset-text">å¤©æ°”åŸå› </text>
            </view>
            <view
              class="preset-item {{deleteReason === 'åœºåœ°é—®é¢˜å–æ¶ˆ' ? 'active' : ''}}"
              bindtap="selectPresetReason"
              data-reason="åœºåœ°é—®é¢˜å–æ¶ˆ"
            >
              <text class="preset-text">åœºåœ°é—®é¢˜</text>
            </view>
            <view
              class="preset-item {{deleteReason === 'äººæ•°ä¸è¶³å–æ¶ˆ' ? 'active' : ''}}"
              bindtap="selectPresetReason"
              data-reason="äººæ•°ä¸è¶³å–æ¶ˆ"
            >
              <text class="preset-text">äººæ•°ä¸è¶³</text>
            </view>
            <view
              class="preset-item {{deleteReason === 'ä¸´æ—¶è°ƒæ•´å–æ¶ˆ' ? 'active' : ''}}"
              bindtap="selectPresetReason"
              data-reason="ä¸´æ—¶è°ƒæ•´å–æ¶ˆ"
            >
              <text class="preset-text">ä¸´æ—¶è°ƒæ•´</text>
            </view>
          </view>

          <!-- è‡ªå®šä¹‰åŸå› è¾“å…¥ -->
          <view class="custom-reason">
            <textarea
              class="reason-input"
              placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰åˆ é™¤åŸå› ..."
              value="{{deleteReason}}"
              bindinput="onDeleteReasonInput"
              maxlength="200"
              show-confirm-bar="{{false}}"
            />
            <view class="char-count">
              <text class="count-text">{{deleteReason.length}}/200</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å¼¹çª—åº•éƒ¨æ“ä½œåŒºåŸŸ -->
      <view class="modal-footer delete-footer">
        <view class="footer-buttons">
          <button class="btn btn-cancel" bindtap="hideDeleteModal">
            <text class="btn-text">å–æ¶ˆ</text>
          </button>
          <button
            class="btn btn-danger"
            bindtap="confirmDeleteEvent"
            disabled="{{isDeleting}}"
            loading="{{isDeleting}}"
          >
            <view class="btn-content">
              <text class="btn-icon" wx:if="{{!isDeleting}}">ğŸ—‘ï¸</text>
              <text class="btn-text">{{isDeleting ? 'åˆ é™¤ä¸­...' : 'ç¡®è®¤åˆ é™¤'}}</text>
            </view>
          </button>
        </view>

        <!-- æœ€åç¡®è®¤æç¤º -->
        <view class="final-warning" wx:if="{{!isDeleting}}">
          <text class="warning-text">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è®­ç»ƒæ´»åŠ¨</text>
        </view>
      </view>
    </view>
  </view>
</view>
