<!--pages/my-profile/my-profile.wxml-->
<view class="page">
  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view wx:if="{{isLoggedIn}}">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{isLoading}}">
      <!-- ç”¨æˆ·ä¿¡æ¯éª¨æ¶å± -->
      <view class="card">
        <view class="user-info">
          <view class="skeleton-avatar skeleton loading-shimmer"></view>
          <view class="user-details">
            <view class="skeleton-text large skeleton loading-shimmer" style="width: 200rpx;"></view>
            <view class="skeleton-text skeleton loading-shimmer" style="width: 120rpx;"></view>
          </view>
        </view>
      </view>

      <!-- ç»Ÿè®¡æ•°æ®éª¨æ¶å± -->
      <view class="card">
        <view class="skeleton-text large skeleton loading-shimmer" style="width: 150rpx; margin-bottom: 30rpx;"></view>
        <view class="stats-grid">
          <view class="stat-item">
            <view class="skeleton-text large skeleton loading-shimmer" style="width: 80rpx;"></view>
            <view class="skeleton-text skeleton loading-shimmer" style="width: 100rpx;"></view>
          </view>
          <view class="stat-item">
            <view class="skeleton-text large skeleton loading-shimmer" style="width: 80rpx;"></view>
            <view class="skeleton-text skeleton loading-shimmer" style="width: 100rpx;"></view>
          </view>
          <view class="stat-item">
            <view class="skeleton-text large skeleton loading-shimmer" style="width: 80rpx;"></view>
            <view class="skeleton-text skeleton loading-shimmer" style="width: 100rpx;"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="card user-card data-appear" wx:else>
      <view class="user-info">
        <view class="avatar-container {{isUploadingAvatar ? 'uploading' : ''}}" bindtap="chooseAvatar">
          <image class="avatar" src="{{displayAvatarUrl}}" mode="aspectFill"></image>
          <view class="avatar-overlay">
            <text class="avatar-edit-text">{{isUploadingAvatar ? 'ä¸Šä¼ ä¸­...' : 'ç‚¹å‡»æ›´æ¢'}}</text>
          </view>
        </view>
        <view class="user-details">
          <text class="nickname">{{userInfo.discName || userInfo.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
          <view class="role-badge {{userInfo.role}}">
            <text>{{userInfo.role === 'admin' ? 'é˜Ÿé•¿' : 'é˜Ÿå‘˜'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• -->
    <view class="card menu-card">
      <text class="card-title">ä¸ªäººè®¾ç½®</text>
      <view class="menu-list">
        <view class="menu-item" bindtap="showEditDiscNameModal">
          <view class="menu-left">
            <text class="menu-icon">âœï¸</text>
            <text class="menu-title">ä¿®æ”¹ç›˜å</text>
          </view>
          <text class="menu-arrow">></text>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡æ•°æ® -->
    <view class="card stats-card">
      <text class="card-title">å‡ºå‹¤ç»Ÿè®¡</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{stats.totalEvents}}</text>
          <text class="stat-label">æŠ¥åè®­ç»ƒ</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{stats.attendedEvents}}</text>
          <text class="stat-label">å®é™…å‡ºå‹¤</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{stats.attendanceRate}}%</text>
          <text class="stat-label">å‡ºå‹¤ç‡</text>
        </view>
      </view>
    </view>

    <!-- æˆ‘çš„è®­ç»ƒè®°å½• -->
    <view class="card">
      <text class="card-title">æˆ‘çš„è®­ç»ƒè®°å½•</text>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{isLoading}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:elif="{{myRegistrations.length === 0}}">
        <view class="empty-icon">ğŸ“…</view>
        <text class="empty-text">æš‚æ— è®­ç»ƒè®°å½•</text>
        <text class="empty-desc">æŠ¥åè®­ç»ƒåè¿™é‡Œä¼šæ˜¾ç¤ºæ‚¨çš„å‡ºå‹¤è®°å½•</text>
      </view>

      <!-- è®°å½•åˆ—è¡¨ -->
      <view class="registration-list" wx:else>
        <view class="registration-item" 
              wx:for="{{myRegistrations}}" 
              wx:key="_id"
              bindtap="goToEventDetail"
              data-event-id="{{item.eventId}}">
          
          <view class="registration-header">
            <text class="event-title">{{item.eventInfo.title}}</text>
            <view class="status-badge {{item.status}}">
              <text>{{item.status === 'signed_up' ? 'å·²æŠ¥å' : item.status === 'leave_requested' ? 'å·²è¯·å‡' : item.status === 'present' ? 'å·²å‡ºå‹¤' : item.status === 'absent' ? 'ç¼ºå‹¤' : 'æœªçŸ¥'}}</text>
            </view>
          </view>

          <view class="registration-info">
            <view class="info-item">
              <text class="info-icon icon icon-time icon-secondary icon-sm"></text>
              <text class="info-text">{{item.eventInfo.formattedTime}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon icon icon-location icon-secondary icon-sm"></text>
              <text class="info-text">{{item.eventInfo.location}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions">
      <button class="btn-danger logout-btn" bindtap="logout">é€€å‡ºç™»å½•</button>
    </view>

    <!-- å¼€å‘å·¥å…·å…¥å£ -->
    <view class="card dev-tools-card">
      <view class="dev-tools-header">
        <text class="section-title">å¼€å‘å·¥å…·</text>
        <text class="dev-badge">DEV</text>
      </view>
      <text class="dev-tools-desc">ç”¨æˆ·èº«ä»½åˆ‡æ¢å’Œæµ‹è¯•æ•°æ®ç®¡ç†</text>
      <button class="btn-dev-tools" bindtap="goToDevTools">æ‰“å¼€å¼€å‘å·¥å…·</button>
    </view>
  </view>

  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="login-prompt" wx:else>
    <view class="prompt-content">
      <view class="prompt-icon icon icon-user icon-gradient icon-2xl"></view>
      <text class="prompt-title">è¯·å…ˆç™»å½•</text>
      <text class="prompt-desc">ç™»å½•åå¯æŸ¥çœ‹ä¸ªäººå‡ºå‹¤è®°å½•</text>
      <button class="btn-primary" bindtap="goToLogin">ç«‹å³ç™»å½•</button>
    </view>
  </view>

  <!-- ç›˜åä¿®æ”¹å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showDiscNameModal}}" bindtap="hideEditDiscNameModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ä¿®æ”¹ç›˜å</text>
        <text class="modal-close" bindtap="hideEditDiscNameModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="current-info">
          <text class="current-name">å½“å‰ç›˜åï¼š{{userInfo.discName || 'æœªè®¾ç½®'}}</text>
          <text class="remaining-count">å‰©ä½™ä¿®æ”¹æ¬¡æ•°ï¼š{{discNameInfo.remainingChanges || 3}} æ¬¡</text>
        </view>

        <view class="input-section" wx:if="{{discNameInfo.canChange !== false}}">
          <view class="input-label">æ–°ç›˜å</view>
          <input
            class="modal-input"
            placeholder="è¯·è¾“å…¥æ–°çš„ç›˜åï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰"
            value="{{newDiscName}}"
            bindinput="onDiscNameInput"
            maxlength="20"
            confirm-type="done"
            bindconfirm="confirmDiscNameChange"
          />
          <view class="input-tips">
            <text class="tip">æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ï¼Œé•¿åº¦2-20ä¸ªå­—ç¬¦</text>
          </view>
        </view>

        <view class="limit-notice" wx:else>
          <text class="limit-text">âš ï¸ å·²è¾¾åˆ°ä¿®æ”¹æ¬¡æ•°é™åˆ¶ï¼ˆ3æ¬¡ï¼‰ï¼Œæ— æ³•å†æ¬¡ä¿®æ”¹</text>
        </view>
      </view>

      <view class="modal-footer" wx:if="{{discNameInfo.canChange !== false}}">
        <button class="btn btn-cancel" bindtap="hideEditDiscNameModal">å–æ¶ˆ</button>
        <button
          class="btn btn-confirm"
          bindtap="confirmDiscNameChange"
          disabled="{{!canSubmitDiscName || isSubmittingDiscName}}"
          loading="{{isSubmittingDiscName}}"
        >
          {{isSubmittingDiscName ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
        </button>
      </view>
    </view>
  </view>
</view>
